if: branch = master

language: android

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    # Android SDK
    - $HOME/android-sdk-dl
    - $HOME/android-sdk
    
    # Gradle deps
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    
    # Android build cache (see https://developer.android.com/studio/build/build-cache.html)
    - $HOME/.android/build-cache
    
install:
  # Download and unzip the Android SDK tools (if not already there thanks to the cache mechanism)
  # Latest version available here: https://developer.android.com/studio/index.html#downloads
  - if test ! -e $HOME/android-sdk-dl/sdk-tools.zip ; then curl https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip > $HOME/android-sdk-dl/sdk-tools.zip ; fi
  - unzip -qq -n $HOME/android-sdk-dl/sdk-tools.zip -d $HOME/android-sdk

  # Install or update Android SDK components (will not do anything if already up to date thanks to the cache mechanism)
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'tools' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'platform-tools' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'build-tools;28.0.3' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'platforms;android-26' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'platforms;android-28' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'extras;google;m2repository' > /dev/null

env:
  global:
    - ANDROID_HOME=$HOME/android-sdk

matrix:
  include:
  - name: "java/advanced/BannerRecyclerViewExample"
    env: PROJ_DIR="java/advanced/BannerRecyclerViewExample"
  - name: "java/advanced/APIDemo"
    env: PROJ_DIR="java/advanced/APIDemo"
  - name: "java/admob/BannerExample"
    env: PROJ_DIR="java/admob/BannerExample"
  - name: "java/admob/RewardedVideoExample"
    env: PROJ_DIR="java/admob/RewardedVideoExample"
  - name: "java/admob/NativeAdvancedExample"
    env: PROJ_DIR="java/admob/NativeAdvancedExample"
  - name: "java/admob/InterstitialExample"
    env: PROJ_DIR="java/admob/InterstitialExample"
  - name: "java/admanager/BannerExample"
    env: PROJ_DIR="java/admanager/BannerExample"
  - name: "java/admanager/CustomRenderingExample"
    env: PROJ_DIR="java/admanager/CustomRenderingExample"
  - name: "java/admanager/RewardedVideoExample"
    env: PROJ_DIR="java/admanager/RewardedVideoExample"
  - name: "java/admanager/InterstitialExample"
    env: PROJ_DIR="java/admanager/InterstitialExample"
  - name: "kotlin/advanced/APIDemo"
    env: PROJ_DIR="kotlin/advanced/APIDemo"
  - name: "kotlin/admob/BannerExample"
    env: PROJ_DIR="kotlin/admob/BannerExample"
  - name: "kotlin/admob/RewardedVideoExample"
    env: PROJ_DIR="kotlin/admob/RewardedVideoExample"
  - name: "kotlin/admob/NativeAdvancedExample"
    env: PROJ_DIR="kotlin/admob/NativeAdvancedExample"
  - name: "kotlin/admob/InterstitialExample"
    env: PROJ_DIR="kotlin/admob/InterstitialExample"
  - name: "kotlin/admanager/BannerExample"
    env: PROJ_DIR="kotlin/admanager/BannerExample"
  - name: "kotlin/admanager/CustomRenderingExample"
    env: PROJ_DIR="kotlin/admanager/CustomRenderingExample"
  - name: "kotlin/admanager/RewardedVideoExample"
    env: PROJ_DIR="kotlin/admanager/RewardedVideoExample"
  - name: "kotlin/admanager/InterstitialExample"
    env: PROJ_DIR="kotlin/admanager/InterstitialExample"

script:
  - CHANGES=$(git --no-pager diff --name-only $TRAVIS_COMMIT_RANGE)  
  - if [[ -n "$(grep -E "(${PROJ_DIR}|\.travis\.yml)" <<< "$CHANGES")" ]]; then
      pushd "$PROJ_DIR";
      ./gradlew build;
      popd;
    fi
